<!DOCTYPE html>
<html lang="en">

<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link href="https://fonts.googleapis.com/css?family=Merriweather:300|Raleway:400,700" rel="stylesheet">
<link rel="stylesheet" href="/assets/css/style.css">
<title>redis笔记-单机数据库实现-数据库</title>
<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>redis笔记-单机数据库实现-数据库 | Jelinet’s Blog</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="redis笔记-单机数据库实现-数据库" />
<meta name="author" content="Jelinet" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="结构" />
<meta property="og:description" content="结构" />
<link rel="canonical" href="http://localhost:4000/redis/2018/06/22/redis%E7%AC%94%E8%AE%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E5%BA%93.html" />
<meta property="og:url" content="http://localhost:4000/redis/2018/06/22/redis%E7%AC%94%E8%AE%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E5%BA%93.html" />
<meta property="og:site_name" content="Jelinet’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-06-22T15:18:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="redis笔记-单机数据库实现-数据库" />
<script type="application/ld+json">
{"headline":"redis笔记-单机数据库实现-数据库","dateModified":"2018-06-22T15:18:00+08:00","datePublished":"2018-06-22T15:18:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/redis/2018/06/22/redis%E7%AC%94%E8%AE%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E5%BA%93.html"},"author":{"@type":"Person","name":"Jelinet"},"url":"http://localhost:4000/redis/2018/06/22/redis%E7%AC%94%E8%AE%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E5%BA%93.html","@type":"BlogPosting","description":"结构","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


</head><body>
  <main class="container">
    <section class="about">
      <div class="about-header condensed">
      <div class="about-title">
      <a href="/">
        
        <img src="/me.jpeg" alt="jelinet" />
        
      </a>
      <h2 id="title">
        <a href="/">jelinet</a>
      </h2>
      </div><p class="tagline">baseball,<br>onsole game,<br>musical&classical&rock,<br>LEGO,<br>programmer.</p></div>
      
      <ul class="social about-footer condensed"><a href="https://github.com/jelinet" target="_blank">
          <li>
            <i class="icon-github-circled"></i>
          </li>
        </a><a href="https://twitter.com/j3l1n37" target="_blank">
          <li>
            <i class="icon-twitter-squared"></i>
          </li>
        </a><a href="https://instagram.com/j3l1n37" target="_blank">
          <li>
            <i class="icon-instagram"></i>
          </li>
        </a></ul><p class="about-footer condensed">&copy;
        2011-2022</p>
    </section>
    <section class="content">
      <div class="post-container">
  <a class="post-link" href="/redis/2018/06/22/redis%E7%AC%94%E8%AE%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E5%BA%93.html">
    <h2 class="post-title">redis笔记-单机数据库实现-数据库</h2>
  </a>
  <div class="post-meta">
    <div class="post-date"><i class="icon-calendar"></i>Jun 22, 2018</div><ul class="post-categories"><li><strong><a href="/category/redis.html">redis</a></strong></li></ul></div>
  <div class="post">
    <h2 id="结构">结构</h2>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">redisServer</span> <span class="p">{</span>
	<span class="c1">// ...</span>
	
  	<span class="c1">// 数据库数组</span>
  	<span class="n">redisDb</span> <span class="o">*</span><span class="n">db</span><span class="p">;</span>
  	<span class="c1">// 服务器的数据库数量</span>
  	<span class="kt">int</span> <span class="n">dbnum</span><span class="p">;</span>
  	
  	<span class="c1">// ...   </span>
<span class="p">}</span>
<span class="o">-----------------------------</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">redisDb</span> <span class="p">{</span>
    <span class="c1">// 数据库键空间，保存着数据库中的所有键值对</span>
    <span class="n">dict</span> <span class="o">*</span><span class="n">dict</span><span class="p">;</span>                 <span class="cm">/* The keyspace for this DB */</span>
    <span class="c1">// 键的过期时间，字典的键为键，字典的值为过期事件 UNIX 时间戳</span>
    <span class="n">dict</span> <span class="o">*</span><span class="n">expires</span><span class="p">;</span>              <span class="cm">/* Timeout of keys with a timeout set */</span>
    
    <span class="c1">// ...</span>
    
<span class="p">}</span> <span class="n">redisDb</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>dbnum 默认是16,select 命令切换数据库，默认使用db[0];</li>
  <li>redisDb中dict，保存了所有的键值对;</li>
  <li>EXISTS、RENAME、KEYS等，这些命令都是通过对键空间进行操作来实现的。
<img src="https://raw.githubusercontent.com/jelinet/jelinet.github.io/main/_posts/image/redis/redisDb1.jpg" alt="redisDb" /></li>
</ul>

<h2 id="过期时间">过期时间</h2>

<ul>
  <li>EXPIRE &lt;key&gt; &lt;ttl&gt; 命令用于将键key的生存时间设置为ttl秒。</li>
  <li>PEXPIRE &lt;key&gt; &lt;ttl&gt; 命令用于将键key的生存时间设置为ttl毫秒。</li>
  <li>EXPIREAT &lt;key&gt; &lt;timestamp&gt; 命令用于将键key的过期时间设置为timestamp所指定的秒数时间戳。</li>
  <li>PEXPIREAT &lt;key&gt; &lt;timestamp&gt; 命令用于将键key的过期时间设置为timestamp所指定的毫秒数时间戳。</li>
  <li>EXPIRE、PEXPIRE、EXPIREAT三个命令都是使用PEXPIREAT命令来实现的。<br />
<img src="https://raw.githubusercontent.com/jelinet/jelinet.github.io/main/_posts/image/redis/db_expier1.jpg" alt="db_expier" /></li>
</ul>

<h2 id="redis服务器实际使用的是惰性删除和定期删除两种策略">Redis服务器实际使用的是惰性删除和定期删除两种策略</h2>

<blockquote>
  <h4 id="概念过期键的三种删除策略">概念：过期键的三种删除策略:</h4>

  <ol>
    <li>定时删除：设置过期时间时，创建timer来控制；对内存友好，对cpu不友好；创建一个定时器需要用到时间事件，当前是用无序链表实现的，查找一个事件的时间复杂度为O(N)，并不能高效地处理大量时间事件;</li>
    <li>惰性删除：每次取键值对时，检查是否过期；cpu友好，内存不友好;</li>
    <li>定期删除：每隔一段时间对数据库进行一次检查;</li>
  </ol>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. **惰性删除**:过期键的惰性删除策略由db.c/expireIfNeeded函数实现;
</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/jelinet/jelinet.github.io/main/_posts/image/redis/expireIfNeeded.jpg" alt="expireIfNeeded" /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2. **定期删除**:过期键的定期删除策略由redis.c/activeExpireCycle函数实现 伪代码:

~~~c
# 默认每次检查的数据库数量

DEFAULT_DB_NUMBERS = 16

# 默认每个数据库检查的键数量
DEFAULT_KEY_NUMBERS = 20

# 全局变量，记录检查进度
current_db = 0

def activeExpireCycle():

# 初始化要检查的数据库数量
# 如果服务器的数据库数量比 DEFAULT_DB_NUMBERS 要小
# 那么以服务器的数据库数量为准
if servesr.dbnum &lt; DEFAULT_DB_NUMBERS:
	db_numbers = server.dbnum
else:
	db_numbers = DEFAULT_DB_NUMBERS

# 遍历各个数据库
for i in range(db_numbers):

    # 如果current_db的值等于服务器的数据库数量
    # 这表示检查程序已经遍历了服务器的所有数据库一次
    # 将current_db重置为0，开始新的一轮遍历
    if current_db == server.dbnum:
        current_db = 0

    # 获取当前要处理的数据库
    redisDb = server.db[current_db]

    # 将数据库索引增1，指向下一个要处理的数据库
    current_db += 1

    # 检查数据库键
    for j in range(DEFAULT_KEY_NUMBERS):

        # 如果数据库中没有一个键带有过期时间，那么跳过这个数据库
        if redisDb.expires.size() == 0: break

        # 随机获取一个带有过期时间的键
        key_with_ttl = redisDb.expires.get_random_key()

        # 检查键是否过期，如果过期就删除它
        if is_expired(key_with_ttl):
            delete_key(key_with_ttl)

        # 已达到时间上限，停止处理
        if reach_time_limit(): return
~~~ 
</code></pre></div></div>

<h2 id="aofrdb和复制功能对过期键的处理">AOF、RDB和复制功能对过期键的处理</h2>

<ul>
  <li><strong>RDB持久化</strong>
    <ol>
      <li>生成RDB，已过期的键不会被保存到新创建的RDB文件中</li>
      <li>载入RDB文件，以主服务器模式运行，对键检查，过期键忽略；从服务模式运行，全部载入；</li>
    </ol>
  </li>
  <li><strong>AOF持久化</strong>
    <ol>
      <li>AOF写入：当过期键被惰性删除或者定期删除之后，程序会向AOF文件追加（append）一条DEL命令，来显式地记录该键已被删除</li>
      <li>AOF重写：已过期的键不会被保存到重写后的AOF文件</li>
    </ol>
  </li>
  <li><strong>复制</strong>
    <ol>
      <li>从服务器只有在接到主服务器发来的DEL命令之后，才会删除过期键</li>
    </ol>
  </li>
</ul>

<h2 id="数据库通知">数据库通知</h2>

<p>客户端通过订阅给定的频道或者模式，来获知数据库中键的变化，以及数据库中命令的执行情况；<a href="http://redisdoc.com/topic/notification.html">详细文档</a><br />
伪代码</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">def</span> <span class="n">notifyKeyspaceEvent</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">dbid</span><span class="p">)</span><span class="o">:</span>

   <span class="cp"># 如果给定的通知不是服务器允许发送的通知，那么直接返回    
</span>   <span class="k">if</span> <span class="n">not</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">notify_keyspace_events</span> <span class="o">&amp;</span> <span class="n">type</span><span class="p">)</span><span class="o">:</span>
           <span class="k">return</span>    
   <span class="cp"># 发送键空间通知 
</span>   <span class="k">if</span> <span class="n">server</span><span class="p">.</span><span class="n">notify_keyspace_events</span> <span class="o">&amp;</span> <span class="n">REDIS_NOTIFY_KEYSPACE</span><span class="o">:</span>
   
           <span class="cp">#将通知发送给频道__keyspace@&lt;dbid&gt;__:&lt;key&gt;
</span>           <span class="cp">#内容为键所发生的事件 &lt;event&gt;        
</span>           
           <span class="cp"># 构建频道名字        
</span>           <span class="n">chan</span> <span class="o">=</span> <span class="s">"__keyspace@{dbid}__:{key}"</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbid</span><span class="o">=</span><span class="n">dbid</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
           
           <span class="cp"># 发送通知        
</span>           <span class="n">pubsubPublishMessage</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>    
   <span class="cp"># 发送键事件通知    
</span>   <span class="k">if</span> <span class="n">server</span><span class="p">.</span><span class="n">notify_keyspace_events</span> <span class="o">&amp;</span> <span class="n">REDIS_NOTIFY_KEYEVENT</span><span class="o">:</span>        
   			<span class="cp">#将通知发送给频道__keyevent@&lt;dbid&gt;__:&lt;event&gt;        
</span>   			<span class="cp">#内容为发生事件的键 &lt;key&gt;        
</span>   			
   			<span class="cp"># 构建频道名字        
</span>   			<span class="n">chan</span> <span class="o">=</span> <span class="s">"__keyevent@{dbid}__:{event}"</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbid</span><span class="o">=</span><span class="n">dbid</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>        
   			
   			<span class="cp"># 发送通知        
</span>   			<span class="n">pubsubPublishMessage</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</code></pre></div></div>

<p>​</p>

  </div></div>

    </section>
    <footer class="condensed">
      <ul class="social about-footer condensed"><a href="https://github.com/jelinet" target="_blank">
          <li>
            <i class="icon-github-circled"></i>
          </li>
        </a><a href="https://twitter.com/j3l1n37" target="_blank">
          <li>
            <i class="icon-twitter-squared"></i>
          </li>
        </a><a href="https://instagram.com/j3l1n37" target="_blank">
          <li>
            <i class="icon-instagram"></i>
          </li>
        </a></ul><p class="about-footer condensed">&copy;
        2011-2022</p>
    </footer>
  </main>
  
</body>

</html>
